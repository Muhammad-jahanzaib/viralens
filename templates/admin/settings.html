{% extends "admin/base_admin.html" %}

{% block header_title %}‚öôÔ∏è System Settings{% endblock %}

{% block admin_extra_css %}
<style>
    /* Tabs Navigation */
    .tabs-container {
        margin-top: 20px;
    }

    .tabs-nav {
        display: flex;
        gap: 5px;
        margin-bottom: 25px;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0;
        overflow-x: auto;
    }

    .tab-button {
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: #64748b;
        font-weight: 500;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
        transition: all 0.2s;
    }

    .tab-button:hover {
        color: #6366f1;
        background-color: #f8fafc;
    }

    .tab-button.active {
        color: #6366f1;
        border-bottom-color: #6366f1;
        font-weight: 600;
        background-color: #f8fafc;
    }

    /* Tab Content */
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Forms */
    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #475569;
        font-size: 14px;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="number"],
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Danger Zone */
    .danger-zone {
        border: 1px solid #fca5a5;
        background: #fef2f2;
        padding: 20px;
        border-radius: 8px;
    }

    .danger-zone h4 {
        color: #991b1b;
        margin-top: 0;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .danger-zone button {
        margin-right: 10px;
        margin-bottom: 10px;
    }

    .api-info {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Feedback Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'success' if category != 'error' else 'danger' }}"
    style="margin-bottom: 20px; padding: 15px; border-radius: 8px; background: {{ '#dcfce7' if category != 'error' else '#fee2e2' }}; color: {{ '#166534' if category != 'error' else '#991b1b' }};">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="tabs-container">
    <div class="tabs-nav">
        <button class="tab-button active" onclick="switchTab('general')">üè¢ General</button>
        <button class="tab-button" onclick="switchTab('email')">üìß Email</button>
        <button class="tab-button" onclick="switchTab('security')">üîí Security</button>
        <button class="tab-button" onclick="switchTab('api')">üîå API</button>
        <button class="tab-button" onclick="switchTab('advanced')">‚öôÔ∏è Advanced</button>
    </div>

    <!-- General Tab -->
    <div id="tab-general" class="tab-content active">
        <div class="section-card">
            <h3>General Settings</h3>
            <form method="post" action="{{ url_for('admin.update_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="tab" value="general">
                <div class="form-group">
                    <label>Site Name</label>
                    <input type="text" name="setting_site_name"
                        value="{{ settings.site_name.value if settings.site_name else 'VIRALENS' }}">
                </div>
                <div class="form-group">
                    <label>Require Approval for New Signups</label>
                    <select name="setting_require_approval">
                        <option value="true" {% if not settings.require_approval or
                            settings.require_approval.value=='true' %}selected{% endif %}>Yes</option>
                        <option value="false" {% if settings.require_approval and
                            settings.require_approval.value=='false' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Default User Tier</label>
                    <select name="setting_default_tier">
                        <option value="free" {% if settings.default_tier and settings.default_tier.value=='free'
                            %}selected{% endif %}>Free</option>
                        <option value="pro" {% if settings.default_tier and settings.default_tier.value=='pro'
                            %}selected{% endif %}>Pro</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">üíæ Save General Settings</button>
            </form>
        </div>
    </div>

    <!-- Email Tab -->
    <div id="tab-email" class="tab-content">
        <div class="section-card">
            <h3>Email Configuration</h3>
            <form method="post" action="{{ url_for('admin.update_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="tab" value="email">
                <div class="form-group">
                    <label>SMTP Server</label>
                    <input type="text" name="setting_smtp_server"
                        value="{{ settings.smtp_server.value if settings.smtp_server else '' }}">
                </div>
                <div class="form-group">
                    <label>SMTP Port</label>
                    <input type="number" name="setting_smtp_port"
                        value="{{ settings.smtp_port.value if settings.smtp_port else '587' }}">
                </div>
                <div class="form-group">
                    <label>From Email</label>
                    <input type="email" name="setting_from_email"
                        value="{{ settings.from_email.value if settings.from_email else '' }}">
                </div>
                <div class="form-group">
                    <label>SMTP Password</label>
                    <input type="password" name="setting_smtp_password"
                        value="{{ settings.smtp_password.value if settings.smtp_password else '' }}">
                </div>
                <button type="submit" class="btn-primary">üíæ Save Email Settings</button>
                <button type="button" class="btn-secondary" onclick="alert('Test email functionality simulated.')">üìß
                    Send Test Email</button>
            </form>
        </div>
    </div>

    <!-- Security Tab -->
    <div id="tab-security" class="tab-content">
        <div class="section-card">
            <h3>Security Settings</h3>
            <form method="post" action="{{ url_for('admin.update_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="tab" value="security">
                <div class="form-group">
                    <label>Session Timeout (minutes)</label>
                    <input type="number" name="setting_session_timeout"
                        value="{{ settings.session_timeout.value if settings.session_timeout else '60' }}">
                </div>
                <div class="form-group">
                    <label>Max Login Attempts</label>
                    <input type="number" name="setting_max_login_attempts"
                        value="{{ settings.max_login_attempts.value if settings.max_login_attempts else '5' }}">
                </div>
                <div class="form-group">
                    <label>Require 2FA for Admins</label>
                    <select name="setting_require_2fa">
                        <option value="true" {% if settings.require_2fa and settings.require_2fa.value=='true'
                            %}selected{% endif %}>Yes</option>
                        <option value="false" {% if not settings.require_2fa or settings.require_2fa.value=='false'
                            %}selected{% endif %}>No</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">üíæ Save Security Settings</button>
            </form>
        </div>
    </div>

    <!-- API Tab -->
    <div id="tab-api" class="tab-content">
        <div class="section-card">
            <h3>API Settings</h3>
            <div class="api-info">
                <p>API Documentation: <a href="#" onclick="alert('Docs coming soon')" style="color:#6366f1;">View Docs
                        ‚Üí</a></p>
                <p>Rate Limit: <strong>100 requests/minute (Default)</strong></p>
            </div>
            <br>
            <form method="post" action="{{ url_for('admin.update_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="tab" value="api">
                <div class="form-group">
                    <label>YouTube API Key</label>
                    <input type="password" name="setting_youtube_api_key"
                        value="{{ settings.youtube_api_key.value if settings.youtube_api_key else '' }}">
                </div>
                <div class="form-group">
                    <label>Google API Key</label>
                    <input type="password" name="setting_google_api_key"
                        value="{{ settings.google_api_key.value if settings.google_api_key else '' }}">
                </div>
                <button type="submit" class="btn-primary">üíæ Save API Settings</button>
            </form>
        </div>
    </div>

    <!-- Advanced Tab -->
    <div id="tab-advanced" class="tab-content">
        <div class="section-card">
            <h3>Advanced Settings</h3>
            <div class="danger-zone">
                <h4>‚ö†Ô∏è Danger Zone</h4>
                <p style="margin-bottom:15px; font-size:14px; color:#ef4444;">These actions are destructive or affect
                    site performance.</p>
                <button class="btn-danger" onclick="if(confirm('Clear all system cache?')) alert('Cache cleared!')">üóë
                    Clear All Cache</button>
                <button class="btn-danger"
                    onclick="if(confirm('Are you SURE you want to reset the database? This cannot be undone.')) alert('Database reset simulated.')">üîÑ
                    Reset Database</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_scripts %}
<script>
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Deactivate all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show target tab
        document.getElementById('tab-' + tabName).classList.add('active');

        // Activate target button
        const activeBtn = document.querySelector(`button[onclick="switchTab('${tabName}')"]`);
        if (activeBtn) activeBtn.classList.add('active');

        // Save state
        localStorage.setItem('adminSettingsTab', tabName);
    }

    // Restore tab on load
    document.addEventListener('DOMContentLoaded', () => {
        const savedTab = localStorage.getItem('adminSettingsTab');
        if (savedTab) {
            switchTab(savedTab);
        }
    });
</script>
{% endblock %}