{% extends "base.html" %}

{% block title %}User Details - Admin Panel - VIRALENS{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <!-- Header -->
    <div class="admin-header">
        <h1>üë§ User Details</h1>
        <div class="admin-nav">
            <a href="{{ url_for('admin.dashboard') }}">Dashboard</a>
            <a href="{{ url_for('admin.users') }}">Users</a>
            <a href="{{ url_for('admin.research_runs') }}">Research Runs</a>
            <a href="{{ url_for('admin.analytics') }}">Analytics</a>
            <a href="{{ url_for('admin.logs') }}">Audit Logs</a>
            <a href="{{ url_for('admin.settings') }}">Settings</a>
            <a href="{{ url_for('admin.users') }}" class="btn-back">‚Üê Back to Users</a>
        </div>
    </div>

    <!-- User Info Card -->
    <div class="section-card">
        <div class="user-header">
            <div>
                <h2>{{ user.username }}
                    {% if user.is_admin %}<span class="badge badge-admin">Admin</span>{% endif %}
                    {% if user.is_active %}
                    <span class="status-active">‚óè Active</span>
                    {% else %}
                    <span class="status-inactive">‚óè Inactive</span>
                    {% endif %}
                </h2>
                <p class="user-meta">
                    User #{{ user.id }} ‚Ä¢ Joined {{ user.created_at.strftime('%B %d, %Y') if user.created_at else
                    'Unknown' }}
                    {% if user.last_login %}
                    ‚Ä¢ Last login {{ user.last_login.strftime('%B %d, %Y') }}
                    {% endif %}
                </p>
            </div>
            <div class="user-actions">
                <form method="post" action="{{ url_for('admin.suspend_user', user_id=user.id) }}"
                    style="display: inline;">
                    <button type="submit" class="btn-warning">
                        {% if user.is_active %}üîí Suspend{% else %}‚úÖ Reactivate{% endif %}
                    </button>
                </form>
                <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}"
                    onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.')"
                    style="display: inline;">
                    <button type="submit" class="btn-danger">üóëÔ∏è Delete</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üî¨</div>
            <div class="stat-content">
                <div class="stat-label">Total Research Runs</div>
                <div class="stat-value">{{ total_research_runs }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-content">
                <div class="stat-label">This Month</div>
                <div class="stat-value">{{ research_runs_this_month }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-content">
                <div class="stat-label">Avg Runtime</div>
                <div class="stat-value">{{ "%.1f"|format(avg_runtime) }}s</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <div class="stat-label">Total API Cost</div>
                <div class="stat-value">${{ "%.2f"|format(total_api_cost) }}</div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="admin-content-grid">
        <!-- User Details Form -->
        <div class="section-card">
            <h2>‚úèÔ∏è Edit User Details</h2>
            <form method="post" action="{{ url_for('admin.edit_user', user_id=user.id) }}">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" value="{{ user.email }}" required>
                </div>

                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" value="{{ user.username }}" required>
                </div>

                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" name="full_name" value="{{ user.full_name or '' }}">
                </div>

                <div class="form-group">
                    <label>Niche/Topic</label>
                    <input type="text" name="niche" value="{{ user.niche or '' }}">
                </div>

                <div class="form-group">
                    <label>Subscription Tier</label>
                    <select name="subscription_tier">
                        <option value="free" {% if user.subscription_tier=='free' %}selected{% endif %}>Free</option>
                        <option value="pro" {% if user.subscription_tier=='pro' %}selected{% endif %}>Pro</option>
                        <option value="agency" {% if user.subscription_tier=='agency' %}selected{% endif %}>Agency
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Subscription Status</label>
                    <select name="subscription_status">
                        <option value="active" {% if user.subscription_status=='active' %}selected{% endif %}>Active
                        </option>
                        <option value="cancelled" {% if user.subscription_status=='cancelled' %}selected{% endif %}>
                            Cancelled</option>
                        <option value="expired" {% if user.subscription_status=='expired' %}selected{% endif %}>Expired
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="is_active" {% if user.is_active %}checked{% endif %}>
                        Active User
                    </label>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                        Admin Privileges
                    </label>
                </div>

                <div class="form-group">
                    <label>Reset Password (leave blank to keep current)</label>
                    <input type="password" name="new_password" placeholder="New password...">
                </div>

                <button type="submit" class="btn-primary">üíæ Save Changes</button>
            </form>
        </div>

        <!-- Recent Activity -->
        <div class="section-card">
            <h2>üìä Recent Activity</h2>
            {% if recent_activity %}
            <div class="activity-timeline">
                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-icon">
                        {% if activity.action == 'login' %}üîë
                        {% elif activity.action == 'research_run' %}üî¨
                        {% elif activity.action == 'export' %}üì•
                        {% else %}üìã
                        {% endif %}
                    </div>
                    <div class="activity-content">
                        <div class="activity-action">{{ activity.action }}</div>
                        <div class="activity-time">{{ activity.created_at.strftime('%b %d, %Y %H:%M') if
                            activity.created_at else 'Unknown' }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-data">No recent activity</p>
            {% endif %}
        </div>
    </div>

    <!-- Recent Research Runs -->
    <div class="section-card">
        <h2>üî¨ Recent Research Runs</h2>
        {% if recent_research %}
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Keywords</th>
                        <th>Topics Generated</th>
                        <th>Sources</th>
                        <th>Runtime</th>
                        <th>API Cost</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for run in recent_research %}
                    <tr>
                        <td>#{{ run.id }}</td>
                        <td>{{ run.keywords|length if run.keywords else 0 }} keywords</td>
                        <td>{{ run.topics_generated }}</td>
                        <td>{{ run.sources_successful }}</td>
                        <td>{{ "%.1f"|format(run.runtime_seconds) }}s</td>
                        <td>${{ "%.2f"|format(run.api_cost) if run.api_cost else '0.00' }}</td>
                        <td>{{ run.created_at.strftime('%Y-%m-%d %H:%M') if run.created_at else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="{{ url_for('admin.research_runs', user_id=user.id) }}" class="btn-link">View All Runs ‚Üí</a>
        {% else %}
        <p class="no-data">No research runs yet</p>
        {% endif %}
    </div>
</div>

<style>
    .user-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
    }

    .user-header h2 {
        margin: 0 0 10px 0;
    }

    .user-meta {
        color: #64748b;
        font-size: 14px;
        margin: 0;
    }

    .user-actions {
        display: flex;
        gap: 10px;
    }

    .btn-warning {
        padding: 10px 20px;
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-warning:hover {
        background: #d97706;
    }

    .btn-danger {
        padding: 10px 20px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #475569;
        font-size: 14px;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-group input[type="checkbox"] {
        margin-right: 8px;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #6366f1;
    }

    .activity-timeline {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .activity-item {
        display: flex;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
    }

    .activity-icon {
        font-size: 24px;
    }

    .activity-content {
        flex: 1;
    }

    .activity-action {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 5px;
    }

    .activity-time {
        color: #64748b;
        font-size: 13px;
    }

    .no-data {
        text-align: center;
        color: #94a3b8;
        padding: 40px;
        font-style: italic;
    }

    @media (max-width: 768px) {
        .user-header {
            flex-direction: column;
            gap: 15px;
        }
    }
</style>
{% endblock %}