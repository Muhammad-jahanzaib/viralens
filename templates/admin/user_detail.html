{% extends "admin/base_admin.html" %}

{% block header_title %}üë§ User Details - {{ user.username }}{% endblock %}

{% block admin_extra_css %}
<style>
    /* User Detail Specific Styles */
    .breadcrumb {
        margin-bottom: 20px;
        color: #64748b;
        font-size: 14px;
    }

    .breadcrumb a {
        color: #6366f1;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .alert-warning {
        background: #fffbeb;
        border: 1px solid #fcd34d;
        color: #92400e;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
    }

    .alert-warning h3 {
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .approval-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .user-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0;
    }

    .user-meta {
        color: #64748b;
        font-size: 14px;
        margin: 5px 0 0 0;
    }

    .user-actions {
        display: flex;
        gap: 10px;
    }

    .approval-actions {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 10px;
    }

    .activity-timeline {
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #f1f5f9;
    }

    .activity-icon {
        font-size: 20px;
        background: white;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 1px solid #e2e8f0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-action {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 2px;
    }

    .activity-time {
        color: #94a3b8;
        font-size: 12px;
    }

    textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        margin-bottom: 10px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
    }

    textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    @media (max-width: 768px) {
        .user-header {
            flex-direction: column;
            gap: 15px;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Breadcrumb -->
<nav class="breadcrumb">
    <a href="{{ url_for('admin.dashboard') }}">Dashboard</a> /
    <a href="{{ url_for('admin.users') }}">Users</a> /
    <span>{{ user.username }}</span>
</nav>

<!-- Pending Approval Alert -->
{% if user.approval_status is defined and user.approval_status == 'pending' %}
<div class="alert alert-warning">
    <h3>‚è≥ Pending Approval</h3>
    <p>This user is awaiting admin approval to access the platform. Please review their details below.</p>
    <div class="approval-actions">
        <form method="POST" action="{{ url_for('admin.approve_user', user_id=user.id) }}" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn-success">‚úì Approve User</button>
        </form>
        <form method="POST" action="{{ url_for('admin.reject_user', user_id=user.id) }}" style="display:inline;"
            onsubmit="return confirm('Reject and delete this user?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn-danger">‚úó Reject User</button>
        </form>
    </div>
</div>
{% endif %}

<!-- User Info Card -->
<div class="section-card">
    <div class="user-header">
        <div>
            <h2>
                {{ user.username }}
                {% if user.is_admin %}<span class="badge badge-admin">Admin</span>{% endif %}

                {% if user.is_active %}
                <span class="status-active">‚óè Active</span>
                {% else %}
                <span class="status-inactive">‚óè Inactive</span>
                {% endif %}
            </h2>
            <p class="user-meta">
                User #{{ user.id }} ‚Ä¢ {{ user.email }}
            </p>
        </div>

        <div class="user-actions">
            <form method="post" action="{{ url_for('admin.suspend_user', user_id=user.id) }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn-warning">
                    {% if user.is_active %}üîí Suspend{% else %}‚úÖ Reactivate{% endif %}
                </button>
            </form>
            <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}"
                onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.')"
                style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn-danger">üóëÔ∏è Delete</button>
            </form>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üî¨</div>
        <div class="stat-content">
            <div class="stat-label">Total Research Runs</div>
            <div class="stat-value">{{ total_research_runs }}</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-content">
            <div class="stat-label">Member Since</div>
            <div class="stat-value">{{ user.created_at.strftime('%b %Y') if user.created_at else 'N/A' }}</div>
            <div class="stat-detail">Joined via Signup</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üîë</div>
        <div class="stat-content">
            <div class="stat-label">Last Login</div>
            <div class="stat-value">{{ user.last_login.strftime('%b %d') if user.last_login else 'Never' }}</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
            <div class="stat-label">Total API Cost</div>
            <div class="stat-value">${{ "%.2f"|format(total_api_cost) }}</div>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="admin-content-grid">
    <!-- Left Column: Edit Form -->
    <div class="section-card">
        <h2>‚úèÔ∏è Edit User Details</h2>
        <form method="post" action="{{ url_for('admin.edit_user', user_id=user.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" value="{{ user.email }}" required>
            </div>

            <div class="form-group">
                <label>Username</label>
                <input type="text" name="username" value="{{ user.username }}" required>
            </div>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="full_name" value="{{ user.full_name or '' }}">
            </div>

            <div class="form-group">
                <label>Niche/Topic</label>
                <input type="text" name="niche" value="{{ user.niche or '' }}">
            </div>

            <div class="form-group">
                <label>Subscription Tier</label>
                <select name="subscription_tier">
                    <option value="free" {% if user.subscription_tier=='free' %}selected{% endif %}>Free</option>
                    <option value="pro" {% if user.subscription_tier=='pro' %}selected{% endif %}>Pro</option>
                    <option value="agency" {% if user.subscription_tier=='agency' %}selected{% endif %}>Agency</option>
                </select>
            </div>

            <div class="form-group">
                <label>Subscription Status</label>
                <select name="subscription_status">
                    <option value="active" {% if user.subscription_status=='active' %}selected{% endif %}>Active
                    </option>
                    <option value="cancelled" {% if user.subscription_status=='cancelled' %}selected{% endif %}>
                        Cancelled</option>
                    <option value="expired" {% if user.subscription_status=='expired' %}selected{% endif %}>Expired
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_active" {% if user.is_active %}checked{% endif %}>
                    Active User
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                    Admin Privileges
                </label>
            </div>

            <div class="form-group">
                <label>Reset Password (leave blank to keep current)</label>
                <input type="password" name="new_password" placeholder="New password...">
            </div>

            <button type="submit" class="btn-primary">üíæ Save Changes</button>
        </form>
    </div>

    <!-- Right Column: Admin Notes & Activity -->
    <div style="display: flex; flex-direction: column; gap: 25px;">
        <!-- Admin Notes Section -->
        <div class="section-card">
            <h3>üìù Admin Notes</h3>
            <textarea id="admin-notes" rows="4"
                placeholder="Internal notes about this user...">{{ user.admin_notes if user.admin_notes is defined else '' }}</textarea>
            <div style="text-align: right;">
                <button class="btn-sm btn-primary" onclick="saveNotes()">Update Notes</button>
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="section-card">
            <h3>üìä Activity Timeline</h3>
            <div id="activity-timeline" class="activity-timeline">
                {% if recent_activity %}
                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-icon">
                        {% if activity.action == 'login' %}üîë
                        {% elif activity.action == 'research_run' %}üî¨
                        {% elif activity.action == 'export' %}üì•
                        {% else %}üìã
                        {% endif %}
                    </div>
                    <div class="activity-content">
                        <div class="activity-action">{{ activity.action|capitalize }}</div>
                        <div class="activity-time">{{ activity.created_at.strftime('%b %d, %Y %H:%M') if
                            activity.created_at else 'Unknown' }}</div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="no-data" style="padding: 20px;">
                    <p>Loading activity...</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Research Runs -->
<div class="section-card">
    <h2>üî¨ Recent Research Runs</h2>
    {% if recent_research %}
    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Keywords</th>
                    <th>Topics</th>
                    <th>Sources</th>
                    <th>Runtime</th>
                    <th>API Cost</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for run in recent_research %}
                <tr>
                    <td>#{{ run.id }}</td>
                    <td>{{ run.keywords|length if run.keywords else 0 }} keys</td>
                    <td>{{ run.topics_generated }}</td>
                    <td>{{ run.sources_successful }}</td>
                    <td>{{ "%.1f"|format(run.runtime_seconds) }}s</td>
                    <td>${{ "%.2f"|format(run.api_cost) if run.api_cost else '0.00' }}</td>
                    <td>{{ run.created_at.strftime('%Y-%m-%d %H:%M') if run.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <a href="{{ url_for('admin.research_runs', user_id=user.id) }}" class="btn-link">View All Runs ‚Üí</a>
    {% else %}
    <p class="no-data">No research runs yet</p>
    {% endif %}
</div>
{% endblock %}

{% block admin_scripts %}
<script>
    function saveNotes() {
        // Placeholder for saving notes behavior
        const btn = document.querySelector('button[onclick="saveNotes()"]');
        const notes = document.getElementById('admin-notes').value;
        const originalText = btn.textContent;

        btn.textContent = 'Saving...';
        btn.disabled = true;

        // Simulate API call
        setTimeout(() => {
            btn.textContent = 'Saved!';
            btn.style.backgroundColor = '#10b981';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.backgroundColor = '';
            }, 2000);
        }, 800);

        console.log('Saving notes:', notes);
    }

    // Simulate loading more activity if needed
    document.addEventListener('DOMContentLoaded', function () {
        const timeline = document.getElementById('activity-timeline');
        // If empty (mock logic), we could load via AJAX here
        if (timeline.querySelector('.no-data p').textContent === 'Loading activity...') {
            // This is just a visual placeholder if no data exists
            setTimeout(() => {
                timeline.innerHTML = '<p class="no-data">No recorded activity found.</p>';
            }, 1000);
        }
    });
</script>
{% endblock %}