{% extends "admin/base_admin.html" %}

{% block header_title %}üë• User Management{% endblock %}

{% block admin_extra_css %}
<style>
    /* Filter Styles */
    .filter-form {
        margin-bottom: 0;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 15px;
        align-items: end;
    }

    /* Bulk Action Toolbar */
    .bulk-toolbar {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: white;
        padding: 12px 24px;
        border-radius: 100px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 20px;
        z-index: 1000;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes slideUp {
        from {
            transform: translate(-50%, 100%);
            opacity: 0;
        }

        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }

    .selected-info {
        font-weight: 600;
        font-size: 14px;
        color: #e2e8f0;
        min-width: 120px;
    }

    .bulk-actions {
        display: flex;
        gap: 8px;
        padding-left: 20px;
        border-left: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Custom Button Colors for Bulk Actions */
    .btn-success {
        background: #10b981;
        color: white;
        border: none;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
        border: none;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .btn-warning {
        background: #f59e0b;
        color: white;
        border: none;
    }

    .btn-warning:hover {
        background: #d97706;
    }

    .btn-primary {
        background: #6366f1;
        color: white;
        border: none;
    }

    .btn-primary:hover {
        background: #4f46e5;
    }

    .btn-secondary {
        padding: 10px 20px;
        background: #f1f5f9;
        color: #64748b;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: #e2e8f0;
        color: #334155;
    }

    /* Checkbox Styles */
    input[type="checkbox"] {
        cursor: pointer;
        width: 16px;
        height: 16px;
        accent-color: #6366f1;
    }

    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }

        .bulk-toolbar {
            width: 90%;
            flex-direction: column;
            gap: 10px;
            bottom: 20px;
            border-radius: 12px;
            padding: 15px;
        }

        .bulk-actions {
            border-left: none;
            padding-left: 0;
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
<!-- Search and Filters -->
<div class="section-card">
    <form method="get" action="{{ url_for('admin.users') }}" class="filter-form">
        <div class="filter-grid">
            <div class="form-group" style="margin-bottom: 0;">
                <label>Search</label>
                <input type="text" name="search" value="{{ search }}" placeholder="Email, username, or name...">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label>Subscription Tier</label>
                <select name="tier">
                    <option value="">All Tiers</option>
                    <option value="free" {% if tier_filter=='free' %}selected{% endif %}>Free</option>
                    <option value="pro" {% if tier_filter=='pro' %}selected{% endif %}>Pro</option>
                    <option value="agency" {% if tier_filter=='agency' %}selected{% endif %}>Agency</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label>Status</label>
                <select name="status">
                    <option value="">All Users</option>
                    <option value="active" {% if status_filter=='active' %}selected{% endif %}>Active</option>
                    <option value="suspended" {% if status_filter=='suspended' %}selected{% endif %}>Suspended</option>
                    <option value="pending" {% if status_filter=='pending' %}selected{% endif %}>Pending Approval
                    </option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label>&nbsp;</label>
                <div style="display: flex;">
                    <button type="submit" class="btn-primary"
                        style="flex: 1; padding: 10px; border-radius: 6px; cursor: pointer;">Filter</button>
                    <a href="{{ url_for('admin.users') }}" class="btn-secondary" style="margin-left: 10px;">Clear</a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Users Table -->
<div class="section-card">
    <div class="table-header">
        <h2>All Users ({{ pagination.total }} total)</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="cleanupTestUsers()" class="btn-action" style="background: #64748b;">üßπ Cleanup Test
                Accounts</button>
            <a href="{{ url_for('admin.export_users') }}" class="btn-action">üì• Export CSV</a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th width="40"><input type="checkbox" id="select-all-users"></th>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Tier</th>
                    <th>Status</th>
                    <th>Approval</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <input type="checkbox" class="user-checkbox" data-user-id="{{ user.id }}">
                    </td>
                    <td>#{{ user.id }}</td>
                    <td>
                        <strong>{{ user.username }}</strong>
                        {% if user.is_admin %}
                        <span class="badge badge-admin">Admin</span>
                        {% endif %}
                    </td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.full_name or '-' }}</td>
                    <td>
                        <span class="badge badge-{{ user.subscription_tier }}">
                            {{ user.subscription_tier }}
                        </span>
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="status-active">‚óè Active</span>
                        {% else %}
                        <span class="status-inactive">‚óè Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.approval_status == 'pending' %}
                        <span class="badge badge-warning">‚è≥ Pending</span>
                        {% elif user.approval_status == 'approved' %}
                        <span class="badge badge-success">‚úì Approved</span>
                        {% elif user.approval_status == 'rejected' %}
                        <span class="badge badge-danger">‚úó Rejected</span>
                        {% else %}
                        <span class="badge badge-secondary">Legacy</span>
                        {% endif %}
                    </td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '-' }}</td>
                    <td>{{ user.last_login.strftime('%Y-%m-%d') if user.last_login else 'Never' }}</td>
                    <td>
                        <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="btn-sm">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="{{ url_for('admin.users', page=pagination.prev_num, search=search, tier=tier_filter, status=status_filter) }}"
            class="page-link">‚Üê Previous</a>
        {% endif %}

        {% for page in pagination.iter_pages() %}
        {% if page %}
        <a href="{{ url_for('admin.users', page=page, search=search, tier=tier_filter, status=status_filter) }}"
            class="page-link {% if page == pagination.page %}active{% endif %}">
            {{ page }}
        </a>
        {% else %}
        <span class="page-link">...</span>
        {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <a href="{{ url_for('admin.users', page=pagination.next_num, search=search, tier=tier_filter, status=status_filter) }}"
            class="page-link">Next ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Bulk Actions Toolbar -->
<div id="bulk-actions-toolbar" class="bulk-toolbar" style="display:none;">
    <div class="selected-info">
        <span id="selected-count">0</span> users selected
    </div>
    <div class="bulk-actions">
        <!-- Real implementation of bulk actions -->
        <button class="btn-sm btn-success" onclick="bulkApprove()">‚úì Approve</button>
        <button class="btn-sm btn-danger" onclick="bulkReject()">‚úó Reject</button>
        <button class="btn-sm btn-warning" onclick="bulkSuspend()">‚è∏ Suspend</button>
        <button class="btn-sm btn-primary" onclick="bulkActivate()">‚ñ∂ Activate</button>
        <button class="btn-sm btn-danger" onclick="bulkDelete()"
            style="background: #ef4444; border: 1px solid white;">üóë Delete</button>
        <button class="btn-sm btn-secondary" onclick="bulkExport()">üì• Export</button>
    </div>
</div>
{% endblock %}

{% block admin_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selectAll = document.getElementById('select-all-users');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');
        const bulkToolbar = document.getElementById('bulk-actions-toolbar');
        const selectedCountSpan = document.getElementById('selected-count');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        function updateToolbar() {
            const selected = document.querySelectorAll('.user-checkbox:checked').length;
            selectedCountSpan.textContent = selected;

            if (selected > 0) {
                bulkToolbar.style.display = 'flex';
            } else {
                bulkToolbar.style.display = 'none';
            }
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.user-checkbox:checked'))
                .map(cb => cb.dataset.userId);
        }

        async function performBulkAction(url, actionName, extraData = {}) {
            const ids = getSelectedIds();
            if (ids.length === 0) return;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        user_ids: ids,
                        ...extraData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success toast or alert? Reloading is safest for state sync
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Bulk action error:', error);
                alert('Failed to perform action');
            }
        }

        // Select All Handler
        if (selectAll) {
            selectAll.addEventListener('change', function () {
                userCheckboxes.forEach(cb => {
                    cb.checked = selectAll.checked;
                });
                updateToolbar();
            });
        }

        // Individual Checkbox Handler
        userCheckboxes.forEach(cb => {
            cb.addEventListener('change', function () {
                updateToolbar();
                if (!this.checked) {
                    selectAll.checked = false;
                } else if (document.querySelectorAll('.user-checkbox:checked').length === userCheckboxes.length) {
                    selectAll.checked = true;
                }
            });
        });

        // Bulk Action Implementations
        window.bulkApprove = function () {
            if (confirm(`Approve ${getSelectedIds().length} users?`)) {
                performBulkAction('/admin/api/users/bulk-approve', 'approve');
            }
        }

        window.bulkReject = function () {
            const reason = prompt("Enter rejection reason:", "Bulk action");
            if (reason) {
                performBulkAction('/admin/api/users/bulk-reject', 'reject', { reason: reason });
            }
        }

        window.bulkSuspend = function () {
            const reason = prompt("Enter suspension reason:", "Policy violation");
            if (reason) {
                performBulkAction('/admin/api/users/bulk-suspend', 'suspend', { reason: reason });
            }
        }

        window.bulkActivate = function () {
            if (confirm(`Activate ${getSelectedIds().length} users?`)) {
                performBulkAction('/admin/api/users/bulk-activate', 'activate');
            }
        }

        window.bulkDelete = function () {
            if (confirm(`‚ö†Ô∏è PERMANENTLY DELETE ${getSelectedIds().length} users?\nThis cannot be undone!`)) {
                performBulkAction('/admin/api/users/bulk-delete', 'delete');
            }
        }

        window.bulkExport = function () {
            const ids = getSelectedIds();
            if (ids.length === 0) return;

            // Create a hidden form to submit for download
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/api/users/bulk-export';

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            const idsInput = document.createElement('input');
            idsInput.type = 'hidden';
            idsInput.name = 'user_ids';
            idsInput.value = JSON.stringify(ids);
            form.appendChild(idsInput);

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        // Maintenance cleanup handler
        window.cleanupTestUsers = async function () {
            if (confirm("‚ö†Ô∏è MAINTENANCE: Permanently delete ALL users with 'user' or 'tester' in their username?\n\nThis will clear all automatically generated test accounts.\nThis action cannot be undone!")) {
                try {
                    const response = await fetch('/admin/api/maintenance/delete-pattern-users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert(`‚úÖ Success: ${data.message}`);
                        window.location.reload();
                    } else {
                        alert(`‚ùå Failed: ${data.message}`);
                    }
                } catch (error) {
                    alert("‚ùå Network error occurred.");
                }
            }
        }
    });
</script>
{% endblock %}